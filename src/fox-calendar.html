<link rel="import" href="../../fox-icon/dist/fox-icon.html"/>

<fox-element name="fox-calendar">

	<tpl>
		<div class="fox-calendar-detail">
			<div class="fox-calendar-toolbar">
				<button class="fox-calendar-cancel">Cancel</button>
				<button class="fox-calendar-set">Set</button>
			</div>
			<div class="fox-calendar-selector">
				<div class="fox-calendar-selector-left">
					<fox-icon id="btn_prev_month" icon="icon-left-nav"></fox-icon>
					<label>{month}月</label>
					<fox-icon id="btn_next_month" icon="icon-right-nav"></fox-icon>
				</div>
				<div class="fox-calendar-selector-right">
					<fox-icon id="btn_prev_year" icon="icon-left-nav"></fox-icon>
					<label>{year}年</label>
					<fox-icon id="btn_next_year" icon="icon-right-nav"></fox-icon>
				</div>
			</div>
			<div class="fox-calendar-week-header">
				<div class="fox-calendar-week-item">
					日
				</div>
				<div class="fox-calendar-week-item">
					一
				</div>
				<div class="fox-calendar-week-item">
					二
				</div>
				<div class="fox-calendar-week-item">
					三
				</div>
				<div class="fox-calendar-week-item">
					四
				</div>
				<div class="fox-calendar-week-item">
					五
				</div>
				<div class="fox-calendar-week-item">
					六
				</div>
			</div>
			<div class="fox-calendar-month-detail">
				<div class="fox-calendar-row" rv-each-row="list">
					<div class="fox-calendar-col" rv-each-col="row">
						{col}
					</div>
				</div>
			</div>
		</div>
	</tpl>

	<script>
		function Calendar(el) {

			function daysInMonth(month, year) {
				return new Date(year, month, 0).getDate();
			}

			function weekInMonth(month, year) {
				return new Date(year, month - 1, 1).getDay();
			}
			
			var self = this;
			
			$(el.$['btn_next_month']).bind('click',function(){
				self.createNextMonth();
			});
			
			$(el.$['btn_prev_month']).bind('click',function(){
				self.createPrevMonth();
			});
			
			$(el.$['btn_prev_year']).bind('click',function(){
				self.createPrevYear();
			});
			
			$(el.$['btn_next_year']).bind('click',function(){
				self.createNextYear();
			});
			
			var _year,_month;

			this.create = function(year, month) {
				_year = year;
				_month = month;
				var list = [];
				list.push([]);
			
				for (var i = 0,l=weekInMonth(month, year),j = daysInMonth(month-1,year); i < l; i++) {
					list[0].push(j-(l-i-1));
				}

				
				for (var i = 1; i <= daysInMonth(month, year); i++) {
					var arr = list[list.length - 1];
					if (arr.length > 6) {
						arr = [];
						list.push(arr);
					}
					arr.push(i);
				}
				for (var i = list[list.length - 1].length; i < 7; i++) {
					list[list.length - 1].push("");
				}
				el.year = year;
				el.month = month;
				el.list = list;
			};
			
			this.createNextMonth = function(){
				_month++;
				if(_month>12){
					_month = 1;
					_year++;
				}
				this.create(_year,_month);
			};
			
			this.createPrevMonth = function(){
				_month--;
				if(_month == 0){
					_month = 12;
					_year--;
				}
				this.create(_year,_month);
			};
			
			this.createNextYear = function(){
				_year++;
				this.create(_year,_month);
			};
			
			this.createPrevYear = function(){
				_year--;	
				this.create(_year,_month);
			};
			
		}

		fox("fox-calendar", {
			lifecycle : {
				created : function() {
					this.calendar = new Calendar(this);
					this.calendar.create(2014, 6);
					
				}
			}
		});

	</script>
</fox-element>