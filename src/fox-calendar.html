<link rel="import" href="../../fox-icon/dist/fox-icon.html"/>
<link rel="stylesheet" href="css/fox-calendar.css">
<fox-element name="fox-calendar">

	<tpl>
		<div class="fox-calendar-detail" id="fox-calendar-container">
			<div class="fox-calendar-toolbar">
				<button class="fox-calendar-cancel" id="fox-calendar-cancel">
					Cancel
				</button>
				<button class="fox-calendar-set" id="fox-calendar-set" disabled="disabled">
					Set
				</button>
			</div>
			<div class="fox-calendar-selector">
				<div class="fox-calendar-selector-left">
					<fox-icon id="btn_prev_month" icon="icon-left-nav"></fox-icon>
					<label>{month}月</label>
					<fox-icon id="btn_next_month" icon="icon-right-nav"></fox-icon>
				</div>
				<div class="fox-calendar-selector-right">
					<fox-icon id="btn_prev_year" icon="icon-left-nav"></fox-icon>
					<label>{year}年</label>
					<fox-icon id="btn_next_year" icon="icon-right-nav"></fox-icon>
				</div>
			</div>
			<div class="fox-calendar-week-header">
				<div class="fox-calendar-week-item">
					日
				</div>
				<div class="fox-calendar-week-item">
					一
				</div>
				<div class="fox-calendar-week-item">
					二
				</div>
				<div class="fox-calendar-week-item">
					三
				</div>
				<div class="fox-calendar-week-item">
					四
				</div>
				<div class="fox-calendar-week-item">
					五
				</div>
				<div class="fox-calendar-week-item">
					六
				</div>
			</div>
			<div class="fox-calendar-month-detail">
				<div class="fox-calendar-row" rv-each-row="list">
					<div class="fox-calendar-col" rv-data-val="col.val" rv-class="col.type" rv-each-col="row">
						<span class="fox-calendar-col-inner"> {col.val} </span>

					</div>
				</div>
			</div>
		</div>
	</tpl>
	<script src="lib/moment/min/moment.min.js"></script>
	<script>
		function Calendar(el) {

			function daysInMonth(month, year) {
				return new Date(year, month, 0).getDate();
			}

			function weekInMonth(month, year) {
				return new Date(year, month - 1, 1).getDay();
			}

			var self = this;

			$(el.$['btn_next_month']).bind('click', function() {
				self.createNextMonth();
			});

			$(el.$['btn_prev_month']).bind('click', function() {
				self.createPrevMonth();
			});

			$(el.$['btn_prev_year']).bind('click', function() {
				self.createPrevYear();
			});

			$(el.$['btn_next_year']).bind('click', function() {
				self.createNextYear();
			});

			var _year, _month;

			var lastCol, lastDate;

			$(el).delegate(".fox-calendar-col.normal", "click", function() {
				$(el.$['fox-calendar-set']).removeAttr("disabled");
				if (lastCol) {
					$(lastCol).removeClass("active");
				}
				$(this).addClass("active");
				lastCol = this;
				lastDate = new Date(_year+"-"+_month+"-"+$(this).data("val"));
				
			});

			$(el).delegate(".fox-calendar-col.prev", "click", function() {
				self.createPrevMonth();
			});
			$(el).delegate(".fox-calendar-col.next", "click", function() {
				self.createNextMonth();
			});

			$(el.$['fox-calendar-cancel']).bind("click", function() {
				el.close();
			});

			$(el.$['fox-calendar-set']).bind("click", function() {
				if(lastDate){
					el.close();
					el.fireSelectEvent(lastDate);
				}
			});

			this.create = function(year, month) {
				lastCol && $(lastCol).removeClass("active");
				_year = year;
				_month = month;
				var list = [];
				list.push([]);

				for (var i = 0, l = weekInMonth(month, year), j = daysInMonth(month - 1, year); i < l; i++) {
					list[0].push({
						"val" : j - (l - i - 1),
						"type" : "prev"
					});
				}

				for (var i = 1; i <= daysInMonth(month, year); i++) {
					var active = "";
					if (lastDate && lastDate.getFullYear() == year && lastDate.getMonth()+1 == month && lastDate.getDate() == i) {
						active = "active";
					}
					var arr = list[list.length - 1];
					if (arr.length > 6) {
						arr = [];
						list.push(arr);
					}
					arr.push({
						"val" : i,
						"type" : "normal " + active
					});
				}

				var count = 0;

				list.forEach(function(arr) {
					count += arr.length;
				});

				for (var i = count, j = 1; i < 42; i++, j++) {
					var arr = list[list.length - 1];
					if (arr.length > 6) {
						arr = [];
						list.push(arr);
					}
					arr.push({
						"val" : j,
						"type" : "next"
					});
				}
				el.year = year;
				el.month = month;
				el.list = list;
			};

			this.createNextMonth = function() {
				_month++;
				if (_month > 12) {
					_month = 1;
					_year++;
				}
				this.create(_year, _month);
			};

			this.createPrevMonth = function() {
				_month--;
				if (_month == 0) {
					_month = 12;
					_year--;
				}
				this.create(_year, _month);
			};

			this.createNextYear = function() {
				_year++;
				this.create(_year, _month);
			};

			this.createPrevYear = function() {
				_year--;
				this.create(_year, _month);
			};

		}

		fox("fox-calendar", {
			lifecycle : {
				created : function() {
					this.calendar = new Calendar(this);
				}
			},
			methods : {
				"init":function(date){
					this.calendar.create(date.getFullYear(), date.getMonth()+1);
				},
				"show" : function() {
					var self = this;
					setTimeout(function() {
						$(self).addClass("active");
					}, 0);

				},
				"close" : function() {
					var self = this;
					$(this).removeClass("active");
					/*
					$(this.$['fox-calendar-container']).bind("webkitTransitionEnd", function() {
											$(self).remove();
										});*/
					
				},
				"fireSelectEvent":function(date){
					xtag.fireEvent(this, 'select', {
						'detail' : date
					});
				}
			}
		});

		fox.ui = fox.ui || {};
		fox.ui.calendar = function(param) {

			param = $.extend({
				"display" : "inline",
				"format" : "yyyy-HH-mm",
				"date" : new Date()
			}, param);

			if (param.display == "bottom") {
				if(param.el.tagName=="INPUT"){
					$(param.el).attr("readonly","readonly");
				}
				$(param.el).bind("click", function() {
					
					var self = this;
					var calendar = this.calendar; 
					if(!calendar){
						calendar = document.createElement("fox-calendar");
						calendar.init(param.date);	
						$('body').append(calendar);
						this.calendar = calendar;
					}
					$(calendar).addClass(param.display).bind("select",function(e){
						var val = "";
						if(typeof param.format == "string"){
							val = moment(e.detail).format(param.format);
						}else if(typeof param.format == "function"){
							val = param.format(e.detail);
						}
						$(self).val(val);
					});
					calendar.show();
				});
			}

		};

	</script>
</fox-element>